<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Igniter</title>
    <style>
        .nc {
            color: red;
        }
        
        .sc {
            color: green;
        }
        
        body {
            background-color: black;
        }
        
        * {
            color: white;
        }
        
        div {
            font-size: 5vw;
            /* text-align: justify; */
            /* border: solid 0.1vw; */
            margin: 1vw;
        }
        
        button, input {
            border-radius: 10px;
            height: 5vw;
            font-size: 3vw;
            border: 0;
            background-color: #3b3b3b;
            color: #ffffff;
            width: 100%;
        }

        input[type=number] {
            padding-left: 1vw;
            -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
            -moz-box-sizing: border-box;    /* Firefox, other Gecko */
            box-sizing: border-box;         /* Opera/IE 8+ */
        }
        
        button[state='not-ready'], button[disabled], input[disabled] {
            background-color: #171717;
            color: #4a4a4a;
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        hr{
            width: 100%;
            height: 4px;
            border: 0;
            background-color: white;
        }

        #fire {
            margin-top: 5vw;
        }
    </style>
</head>

<body>
    <div>
        Ping: <a id='connection-status'></a><a> </a><a id='ping'></a>
    </div>
    <div>
        Kaitiklis: <a id='heater-status'></a>
    </div>
    <div>
        Relė: <a id='relay-status'></a>
    </div>
    <div>
        Jungiklis: <a id='switch-status'></a>
    </div>
    <hr>
    <div style='height: 100%'>
        <a>Delay:</a>
        <input type='number' id='delay' min='0' value='0'>
        <a>Kiek degam:</a>
        <input type='number' id='length' min='0' value='3'>
        <button id='fire'>Degam</button>
        <div>Approx:<a id='timeLeft'></a></div>
        <div>Real:<a id='realTimeLeft'></a></div>
    </div>

    <script>
        var polling;
        var connected = false;

        var timeLeft = 0;
        var counting = false;

        let updateCounting = function(val) {
            counting = val;
            updateButton();
        }

        let formatTime = function(t) {
            return (t / 1000).toFixed(1) + ' s';
        }

        changeState = function(elem, state) {
            var states = [['nc', 'nepajungta'], ['sc', 'pajungta']];
            if(typeof(elem) === 'string') { elem = document.getElementById(elem); }
            if(typeof(state) === 'boolean') { state = (state) ? 1 : 0; }
            elem.className = states[state][0];
            elem.innerText = states[state][1];
        };

        let changeButtonState = function(st) {
            document.getElementById('fire').setAttribute('state', st ? 'ready' : 'not-ready');
        };

        let startCountdown = function(delay) {
            updateCounting(true);
            timeLeft = delay * 1000;

            let update = function() {
                document.getElementById('timeLeft').innerHTML = formatTime(timeLeft);
            };

            update();

            let subtractInterval = setInterval(function() {
                if(!counting) {
                    clearInterval(subtractInterval);
                    document.getElementById('timeLeft').innerHTML = '';
                    return;
                }
                timeLeft -= 100;
                update();
            }, 100);
        };

        let resetAllStates = function() {
            document.getElementById('ping').innerText = '';
            changeState('connection-status', false);
            changeState('heater-status', false);
            changeState('relay-status', false);
            changeState('switch-status', false);
            changeButtonState(false);
            connected = false;
        };

        let updateButton = function() {
            let btn = document.getElementById('fire');
            if(!counting) {
                btn.innerHTML = 'Degam';
                btn.onclick = function() {
                    if(!connected) { alert('Nera pingo'); return; }
                    if(this.getAttribute('state') === 'not-ready')
                    {
                        let x = confirm('Ne visi dalykai pajungti, ar tikrai nori degint?');
                        if(!x) return;
                    }
        
                    let delay = parseInt(document.getElementById('delay').value);
                    let length = parseInt(document.getElementById('length').value);
        
                    if(delay < 0 || length < 0) { alert('Neigiamas skaicius'); return; }
        
                    let req = new XMLHttpRequest();
                    req.open('GET', '/fire?delay=' + delay + '&length=' + length, true);
                    req.timeout = 1000;
        
                    req.onload = function() {
                        let resp = req.responseText;
                        startCountdown(delay);
                        if(resp !== 'ok') alert('bad resp: ' + resp);
                    }
        
                    let handleerror = function() {
                        alert('Nepasijungiau kazkodel');
                    }
        
                    req.send();
                }
            } else {
                btn.innerHTML = 'Atšaukt';
                btn.onclick = function() {
                    if(!connected) { alert('Nera pingo'); return; }
        
                    let req = new XMLHttpRequest();
                    req.open('GET', '/cancel', true);
                    req.timeout = 1000;
        
                    req.onload = function() {
                        let resp = req.responseText;
                        if(resp !== 'ok') alert('bad resp: ' + resp);
                        else {
                            updateCounting(false);
                            updateButton();
                        }
                    }
        
                    let handleerror = function() {
                        alert('nepasijungiau kazkodel');
                    }
        
                    req.send();
                }
            }
        }

        document.body.onload = function() {
            resetAllStates();
            updateButton();

            polling = setInterval(function() {
                let req = new XMLHttpRequest();
                req.open('GET', '/ping', true);
                req.timeout = 500;

                req.onload = function() {
                    let time = performance.now() - start;

                    let splitup = req.responseText.split(';');
                    if(splitup.length > 1) {
                        updateCounting(true);
                        timeLeft = parseInt(splitup[1]);
                        document.getElementById('realTimeLeft').innerHTML = formatTime(splitup[1]);
                    }else{
                        updateCounting(false);
                        document.getElementById('realTimeLeft').innerHTML = '';
                    }

                    let state_names = ['switch', 'relay', 'heater'];

                    let states = {};
                    let all_true = true;
                    for(let i = 0; i < state_names.length; i++){
                        let cstate = req.responseText[i] === '1';
                        states[state_names[i]] = cstate;
                        all_true &= cstate;
                    }

                    changeState('connection-status', true);
                    changeState('heater-status', states['heater']);
                    changeState('relay-status', states['relay']);
                    changeState('switch-status', states['switch']);

                    connected = true;
                    changeButtonState(all_true);

                    document.getElementById('ping').innerText = '(' + time + ' ms)';
                };

                req.onerror = resetAllStates;
                req.ontimeout = resetAllStates;

                var start = performance.now();
                
                req.send();
            }, 1000);
        };
    </script>
</body>
</html>